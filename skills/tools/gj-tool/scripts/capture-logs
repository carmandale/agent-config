#!/bin/bash
# Captures visionOS/iOS simulator logs to timestamped file
# Captures at DEBUG level to include all log messages (debug, info, default, error, fault)
# Usage: ~/.claude/skills/xcode-build/scripts/capture-logs <subsystem-or-bundle-id> [simulator-id]
# Example: ~/.claude/skills/xcode-build/scripts/capture-logs com.yourapp.vision
# Example: ~/.claude/skills/xcode-build/scripts/capture-logs com.yourapp.vision booted

set -e

if [ $# -eq 0 ]; then
  echo "âŒ Usage: ./claude/scripts/capture-logs <subsystem-or-bundle-id> [simulator-id]"
  echo "   Example: ./claude/scripts/capture-logs com.yourapp.vision"
  echo "   Example: ./claude/scripts/capture-logs com.yourapp.vision booted"
  exit 1
fi

SUBSYSTEM=$1
SIM_ID=${2:-booted}
TIMESTAMP=$(date +%Y%m%d-%H%M%S)
OUTPUT="./build/logs/logs-${TIMESTAMP}.txt"

# Ensure output directory exists
mkdir -p ./build/logs

echo "ğŸ“ Starting log capture (debug level)..."
echo "   Subsystem: $SUBSYSTEM"
echo "   Simulator: $SIM_ID"
echo "   Log Level: debug (captures all levels)"
echo "   Output: $OUTPUT"
echo ""

# Check if app is running
echo "ğŸ” Checking if app is running..."
RUNNING_APPS=$(xcrun simctl spawn "$SIM_ID" launchctl list 2>/dev/null | grep "$SUBSYSTEM" || true)

if [ -z "$RUNNING_APPS" ]; then
  echo "âš ï¸  WARNING: App with bundle ID '$SUBSYSTEM' is NOT currently running!"
  echo ""
  echo "âš ï¸  CRITICAL: You must install and launch the app BEFORE capturing logs!"
  echo ""
  echo "Required workflow:"
  echo "   1. Build: ~/.claude/skills/xcode-build/scripts/xcodebuild -project X.xcodeproj -scheme Y build"
  echo "   2. Install & Launch: ~/.claude/skills/xcode-build/scripts/install-and-launch $SUBSYSTEM"
  echo "   3. THEN capture logs (this command)"
  echo ""
  echo "Continuing anyway - but logs will be EMPTY unless you launch the app..."
  echo ""
  sleep 2
else
  echo "   âœ… App is running"
fi

echo ""

# Start capturing logs filtered by subsystem in background
# --level debug captures all log levels (debug, info, default, error, fault)
xcrun simctl spawn "$SIM_ID" log stream --level debug --predicate "subsystem == '${SUBSYSTEM}'" > "$OUTPUT" 2>&1 &
PID=$!

# Store the PID so we can stop it later
echo "$PID" > ./build/logs/.last-capture-pid

echo "âœ… Log capture started"
echo "ğŸ”¢ Process ID: $PID"
echo "ğŸ›‘ To stop capturing, run: ./claude/scripts/stop-logs"
echo "ğŸ“‚ Logs will be saved to: $OUTPUT"
