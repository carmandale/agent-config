#!/bin/bash
# Installs and launches app on simulator
# This is a REQUIRED step between building and capturing logs!
#
# Usage: ~/.claude/skills/xcode-build/scripts/install-and-launch <bundle-id> [simulator-id]
# Example: ~/.claude/skills/xcode-build/scripts/install-and-launch com.example.myapp
# Example: ~/.claude/skills/xcode-build/scripts/install-and-launch com.example.myapp booted

set -e

if [ $# -eq 0 ]; then
  echo "‚ùå Usage: install-and-launch <bundle-id> [simulator-id]"
  echo "   Example: install-and-launch com.example.myapp"
  echo "   Example: install-and-launch com.example.myapp booted"
  exit 1
fi

BUNDLE_ID=$1
SIM_ID=${2:-booted}

echo "üì± Installing and launching app on simulator..."
echo "   Bundle ID: $BUNDLE_ID"
echo "   Simulator: $SIM_ID"
echo ""

# Find the most recent .app bundle in DerivedData or build directory
echo "üîç Finding built .app bundle..."
APP_PATH=$(find ~/Library/Developer/Xcode/DerivedData -name "*.app" -path "*/Build/Products/*" -print0 2>/dev/null |
  xargs -0 ls -t 2>/dev/null |
  head -1)

if [ -z "$APP_PATH" ]; then
  # Try local build directory as fallback
  APP_PATH=$(find ./build -name "*.app" -type d 2>/dev/null | head -1)
fi

if [ -z "$APP_PATH" ]; then
  echo "‚ùå Error: Could not find built .app bundle"
  echo ""
  echo "üí° Make sure you've built the app first:"
  echo "   ~/.claude/skills/xcode-build/scripts/xcodebuild -project YourApp.xcodeproj -scheme YourScheme build -destination 'generic/platform=visionOS Simulator'"
  exit 1
fi

echo "   Found: $APP_PATH"
echo ""

# Check if simulator is booted
echo "üîÑ Checking simulator status..."
SIM_STATE=$(xcrun simctl list devices | grep "$SIM_ID" | grep -o "Booted\|Shutdown" || echo "Unknown")

if [ "$SIM_STATE" != "Booted" ]; then
  echo "‚ö†Ô∏è  Simulator is not booted (state: $SIM_STATE)"
  echo "   Attempting to boot simulator..."

  if [ "$SIM_ID" = "booted" ]; then
    echo "‚ùå Error: No simulator is currently booted"
    echo ""
    echo "üí° Boot a simulator first:"
    echo "   1. Open Xcode"
    echo "   2. Choose a simulator from the device menu"
    echo "   3. Or use: xcrun simctl boot <device-id>"
    exit 1
  fi

  xcrun simctl boot "$SIM_ID" 2>/dev/null || true
  sleep 2
fi

# Install the app
echo "üì¶ Installing app to simulator..."
xcrun simctl install "$SIM_ID" "$APP_PATH"

if [ $? -ne 0 ]; then
  echo "‚ùå Failed to install app"
  exit 1
fi

echo "   ‚úÖ App installed"
echo ""

# Launch the app
echo "üöÄ Launching app..."
xcrun simctl launch --console-pty "$SIM_ID" "$BUNDLE_ID"

if [ $? -ne 0 ]; then
  echo "‚ùå Failed to launch app"
  exit 1
fi

echo ""
echo "‚úÖ App launched successfully!"
echo ""
echo "üí° Next steps:"
echo "   1. Interact with the app in the simulator"
echo "   2. Reproduce any issues you're debugging"
echo "   3. When done, stop logs: ~/.claude/skills/xcode-build/scripts/stop-logs"
echo ""
